import streamlit as st
import google.generativeai as genai
import pandas as pd
from datetime import datetime
import io
import xlsxwriter

# --- C·∫§U H√åNH TRANG WEB ---
st.set_page_config(page_title="KOC AI Content Generator", page_icon="üöÄ", layout="wide")

# --- TI√äU ƒê·ªÄ ·ª®NG D·ª§NG ---
st.title("üöÄ KOC AI: C·ªó M√°y T·∫°o K·ªãch B·∫£n B√°n H√†ng")
st.markdown("---")

# --- C·ªòT B√äN TR√ÅI: NH·∫¨P LI·ªÜU ---
with st.sidebar:
    st.header("‚öôÔ∏è Nh·∫≠p th√¥ng tin")
    
    api_key = st.text_input("Nh·∫≠p Google API Key c·ªßa b·∫°n:", type="password", help="L·∫•y mi·ªÖn ph√≠ t·∫°i aistudio.google.com")
    
    st.markdown("---")
    product_name = st.text_input("T√™n s·∫£n ph·∫©m", "V√≠ d·ª•: N·ªìi chi√™n kh√¥ng d·∫ßu Sunhouse")
    product_features = st.text_area("ƒê·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t (USP)", "V√≠ d·ª•: Gi·∫£m 80% m·ª°, dung t√≠ch 6L, m√†n h√¨nh c·∫£m ·ª©ng, ƒëang sale 50%")
    target_audience = st.text_input("Kh√°ch h√†ng m·ª•c ti√™u", "V√≠ d·ª•: M·∫π b·ªâm s·ªØa, Nh√¢n vi√™n vƒÉn ph√≤ng")
    
    submit_button = st.button("‚ú® T·∫†O K·∫æ HO·∫†CH NGAY", type="primary")

# --- C·ªòT B√äN PH·∫¢I: K·∫æT QU·∫¢ ---
if submit_button:
    if not api_key:
        st.error("‚ö†Ô∏è Vui l√≤ng nh·∫≠p API Key ƒë·ªÉ b·∫Øt ƒë·∫ßu!")
    else:
        try:
            genai.configure(api_key=api_key)
            model = genai.GenerativeModel('gemini-1.5-flash')
            
            with st.spinner('ü§ñ AI ƒëang t∆∞ duy v√† vi·∫øt k·ªãch b·∫£n... Vui l√≤ng ch·ªù 10s...'):
                prompt = f"""
                B·∫°n l√† Top KOC Reviewer. L·∫≠p k·∫ø ho·∫°ch 5 NG√ÄY n·ªôi dung b√°n s·∫£n ph·∫©m:
                - S·∫£n ph·∫©m: {product_name}
                - ƒê·∫∑c ƒëi·ªÉm: {product_features}
                - Kh√°ch h√†ng: {target_audience}
                
                Y√™u c·∫ßu: T·∫°o b·∫£ng d·ªØ li·ªáu 5 d√≤ng, ngƒÉn c√°ch b·ªüi d·∫•u "|". 
                C·ªôt: Ng√†y | Ch·ªß ƒê·ªÅ | Hook (3s ƒë·∫ßu) | N·ªôi dung ch√≠nh | Caption Facebook | Hashtag
                Kh√¥ng vi·∫øt l·ªùi d·∫´n. D√≤ng ƒë·∫ßu l√† ti√™u ƒë·ªÅ.
                """
                
                response = model.generate_content(prompt)
                result_text = response.text
                
                lines = [line for line in result_text.split('\n') if "|" in line]
                if len(lines) > 1:
                    # S·ª≠a l·ªói hi·ªÉn th·ªã b·∫±ng c√°ch l√†m s·∫°ch d·ªØ li·ªáu
                    data = [x.split('|') for x in lines[1:]]
                    columns = [x.strip() for x in lines[0].split('|')]
                    # X√≥a c√°c c·ªôt tr·ªëng n·∫øu c√≥ do split th·ª´a
                    if len(columns) > len(data[0]):
                        columns = columns[:len(data[0])]
                    
                    df = pd.DataFrame(data, columns=columns)
                    
                    st.success("‚úÖ ƒê√£ xong! K·∫ø ho·∫°ch content c·ªßa b·∫°n ƒë√¢y:")
                    st.dataframe(df, use_container_width=True)
                    
                    output = io.BytesIO()
                    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
                        df.to_excel(writer, index=False, sheet_name='KeHoachKOC')
                    processed_data = output.getvalue()
                    
                    st.download_button(
                        label="üì• T·∫£i File Excel K·∫ø Ho·∫°ch V·ªÅ M√°y",
                        data=processed_data,
                        file_name=f"KeHoach_{datetime.now().strftime('%Y%m%d')}.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    )
                else:
                    st.error("AI tr·∫£ v·ªÅ d·ªØ li·ªáu l·ªói. H√£y th·ª≠ l·∫°i!")
                    st.text(result_text)
                    
        except Exception as e:
            st.error(f"C√≥ l·ªói x·∫£y ra: {e}")
